<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Disk B-Spline Test Harness</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .curve-container {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
    }
    .example-content {
      display: flex;
      gap: 20px;
    }
    .data-column {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .visual-column {
      flex: 2;
    }
    .controls {
      margin-bottom: 10px;
    }
    h2 {
      margin-top: 0;
    }
    svg {
      background-color: #f8f8f8;
      width: 100%;
      height: 100%;
      min-height: 200px;
    }
    .log {
      font-family: monospace;
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
    }
    textarea {
      width: 100%;
      height: 100%;
      min-height: 140px;
      font-family: monospace;
      resize: vertical;
    }
    .error-message {
      color: red;
      font-size: 0.9em;
      margin-top: 5px;
    }
    .instructions {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <h1>Disk B-Spline Test Harness</h1>
  
  <div class="controls" style="margin-bottom: 20px;">
    <label><input type="checkbox" id="showSkeletonToggle" checked> Show Skeleton Path</label>
    <label style="margin-left: 20px;"><input type="checkbox" id="showNormalsToggle" checked> Show Normal Vectors</label>
    <label style="margin-left: 20px;"><input type="checkbox" id="showControlDisksToggle" checked> Show Control Disks</label>
  </div>
  
  <div class="container" id="examples-container">
    <!-- Examples will be dynamically generated here -->
  </div>
  
  <div>
    <h2>Debug Log</h2>
    <div id="log" class="log"></div>
  </div>

  <!-- Import the DiskBSpline library -->
  <script src="../index.js"></script>
  
  <script>
    // Define examples data
    const examplesData = [
      {
        id: "example1",
        title: "Example 1: Simple Variable Width Curve",
        fillColor: "steelblue",
        data: "50,150,10\n150,50,25\n250,150,15\n350,100,5"
      },
      {
        id: "example2",
        title: "Example 2: Complex Variable Width Curve",
        fillColor: "purple",
        opacity: 0.7,
        data: "50,100,5\n100,50,20\n150,150,30\n200,60,15\n250,120,25\n300,80,10\n350,100,5"
      },
      {
        id: "example3",
        title: "Example 3: Calligraphic Stroke",
        fillColor: "black",
        data: "50,100,3\n100,120,10\n150,80,15\n200,150,20\n250,50,15\n300,120,10\n350,100,3"
      },
      {
        id: "example4",
        title: "Example 4: Calligraphic Effect",
        fillColor: "#333",
        data: "50,100,3\n100,80,8\n150,50,20\n200,80,30\n250,150,15\n300,120,7\n350,100,3"
      },
      {
        id: "example5",
        title: "Example 5: Interactive Curve",
        fillColor: "green",
        opacity: 0.7,
        data: "50,100,10\n150,100,15\n250,100,20\n350,100,10"
      }
    ];

    // Helper function to create SVG content
    function createSVG(width, height, content) {
      return `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
        ${content}
      </svg>`;
    }

    // Parse text data into control disks
    function parseControlDisks(text) {
      const lines = text.trim().split('\n');
      const controlDisks = [];
      let hasError = false;
      
      for (const line of lines) {
        const parts = line.trim().split(',');
        if (parts.length !== 3) {
          hasError = true;
          continue;
        }
        
        const x = parseFloat(parts[0]);
        const y = parseFloat(parts[1]);
        const radius = parseFloat(parts[2]);
        
        if (isNaN(x) || isNaN(y) || isNaN(radius) || radius < 0) {
          hasError = true;
          continue;
        }
        
        controlDisks.push({
          center: { x, y },
          radius
        });
      }
      
      return { controlDisks, hasError };
    }

    // Function to create a curve container
    function createCurveContainer(example) {
      const container = document.createElement('div');
      container.className = 'curve-container';
      
      const heading = document.createElement('h2');
      heading.textContent = example.title;
      container.appendChild(heading);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'example-content';
      
      // Data column with textarea
      const dataColumn = document.createElement('div');
      dataColumn.className = 'data-column';
      
      const instructions = document.createElement('div');
      instructions.className = 'instructions';
      instructions.textContent = 'Format: x,y,radius (one per line)';
      dataColumn.appendChild(instructions);
      
      const textarea = document.createElement('textarea');
      textarea.id = `${example.id}-data`;
      textarea.value = example.data;
      textarea.addEventListener('input', () => updateCurve(example.id));
      dataColumn.appendChild(textarea);
      
      const errorDiv = document.createElement('div');
      errorDiv.id = `${example.id}-error`;
      errorDiv.className = 'error-message';
      dataColumn.appendChild(errorDiv);
      
      // Visual column for the curve
      const visualColumn = document.createElement('div');
      visualColumn.className = 'visual-column';
      visualColumn.id = example.id;
      
      contentDiv.appendChild(dataColumn);
      contentDiv.appendChild(visualColumn);
      
      container.appendChild(contentDiv);
      
      return container;
    }

    // Function to update a curve based on textarea data
    function updateCurve(exampleId) {
      const textarea = document.getElementById(`${exampleId}-data`);
      const errorDiv = document.getElementById(`${exampleId}-error`);
      const visualDiv = document.getElementById(exampleId);
      
      // Get the example data
      const example = examplesData.find(e => e.id === exampleId);
      if (!example) return;
      
      // Parse the control disks
      const { controlDisks, hasError } = parseControlDisks(textarea.value);
      
      // Check if we have enough control disks for a cubic B-spline
      if (controlDisks.length < 4) {
        errorDiv.textContent = 'Need at least 4 control points for a cubic B-spline';
        visualDiv.innerHTML = '';
        return;
      }
      
      if (hasError) {
        errorDiv.textContent = 'Some lines failed to parse. Format should be x,y,radius (one per line).';
      } else {
        errorDiv.textContent = '';
      }
      
      // Create B-spline
      const bspline = new DiskBSpline(controlDisks);
      
      // Get toggle states
      const showSkeleton = document.getElementById('showSkeletonToggle').checked;
      const showNormals = document.getElementById('showNormalsToggle').checked;
      const showControlDisks = document.getElementById('showControlDisksToggle').checked;
      
      // Generate paths
      const result = bspline.toSVGPath(100);
      const controlCircles = showControlDisks ? bspline.controlDisksToSVG() : '';
      
      // Add normal vectors visualization if enabled
      let normalLines = '';
      
      if (showNormals) {
        for (let i = 0; i < result.disks.length; i += Math.floor(result.disks.length / 15)) {
          const disk = result.disks[i];
          const normal = result.normals[i];
          
          normalLines += `<line x1="${disk.center.x}" y1="${disk.center.y}" 
                               x2="${disk.center.x + normal.x * disk.radius}" 
                               y2="${disk.center.y + normal.y * disk.radius}" 
                               stroke="blue" stroke-width="1.5" />`;
          normalLines += `<line x1="${disk.center.x}" y1="${disk.center.y}" 
                               x2="${disk.center.x - normal.x * disk.radius}" 
                               y2="${disk.center.y - normal.y * disk.radius}" 
                               stroke="red" stroke-width="1.5" />`;
        }
      }
      
      // Create the skeleton path element if enabled
      const skeletonPathElement = showSkeleton ? 
        `<path d="${result.skeletonPath}" fill="none" stroke="#333" stroke-width="2" class="skeleton-path" />` : '';
      
      // Apply opacity if specified
      const opacityAttr = example.opacity ? ` opacity="${example.opacity}"` : '';
      
      const svgContent = `
        <path d="${result.fillPath}" fill="${example.fillColor}"${opacityAttr} stroke="none" />
        ${skeletonPathElement}
        ${controlCircles}
        ${normalLines}
      `;
      
      // Create SVG
      visualDiv.innerHTML = createSVG(400, 200, svgContent);
    }

    // Initialize all examples
    function initExamples() {
      const container = document.getElementById('examples-container');
      
      // Create all examples
      examplesData.forEach(example => {
        container.appendChild(createCurveContainer(example));
        updateCurve(example.id);
      });
    }

    // Function to redraw all examples
    function redrawAllExamples() {
      examplesData.forEach(example => {
        updateCurve(example.id);
      });
    }

    // Initialize all examples
    initExamples();
    
    // Add event listeners for the toggle options
    document.getElementById('showSkeletonToggle').addEventListener('change', redrawAllExamples);
    document.getElementById('showNormalsToggle').addEventListener('change', redrawAllExamples);
    document.getElementById('showControlDisksToggle').addEventListener('change', redrawAllExamples);
  </script>
</body>
</html>